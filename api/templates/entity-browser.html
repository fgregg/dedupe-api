{% extends 'base.html' %}
{% block title %}Dedupe sessions{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-12 overflow-container" id="group-table">
        <table class="table table-bordered table-condensed">
            <thead>
                <tr>
                    <th>View individual records</th>
                    {% for field in fields %}
                        <th>{{ field }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for entity in entities %}
                    <tr id="{{ entity.entity_id }}">
                        <td>
                            <a href="javascript://" class="reveal-records" data-entity_id="{{ entity.entity_id }}">
                                <i class="fa fa-arrow-down"> </i>
                            </a>
                        </td>
                        {% for field in fields %}
                            <td>{{ entity|attr(field) }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block extra_javascript %}
<script src="{{ url_for('static', filename='js/ejs_production.js') }}"></script>
<script type="text/EJS" id="recordsTemplate">
    <% $.each(records, function(i, record){ %>
        <tr>
            <td></td>
            <% $.each(fields, function(i, field){ %>
                <td><%= record[field] %> </td>
            <% }) %>
        </tr>
    <% }) %>
</script>
<script type="text/javascript">
    var fields = {{ fields|tojson|safe }};
    $(document).ready(function(){
        $('.reveal-records').on('click', function(){
            var entity_id = $(this).data('entity_id');
            var entity_row = $('tr#' + entity_id);
            console.log(entity_id);
            $.when(getRecords(entity_id)).then(function(resp){
                console.log(resp);
                var tpl = new EJS({'text': $('#recordsTemplate').html()});
                $(entity_row).insertAfter(tpl.render({fields: fields,records:resp.records}))

            })
        })
    })
    function getRecords(entity_id){
        return $.ajax({
            type: 'GET',
            url: '/get-entity-records/',
            data: {'entity_id': entity_id},
            contentType: 'application/json'
        })
    }
</script>
{% endblock %}
